import util
import src
from src import allostery

from glob import glob
import matplotlib.pyplot as plt
import matplotlib as mpl
import numpy as np

from plotnine import *
from plotnine.options import *

configfile: "config.yaml"

DATASETS = [
    "gfp-brightness",
    "laci-ec50",
    "laci-ginf",
    "laci-joint",
    "covid-exp",
    "covid-bind",
    "covid-joint",
]

TORCH_MODELS = [
    "lantern",
    "feedforward-K1-D1-W32",
    "feedforward-K8-D1-W32",
    "linear"
]

MODELS = TORCH_MODELS + ["globalep"]


include: "smk/data.smk"
include: "smk/lantern.smk"
include: "smk/feedforward.smk"
include: "smk/linear.smk"
include: "smk/globalep.smk"
include: "smk/allostery.smk"

include: "smk/figures/cvr2.smk"
include: "smk/figures/calibration.smk"
include: "smk/figures/surface.smk"
include: "smk/figures/sample-size.smk"
include: "smk/figures/anglehist.smk"
include: "smk/figures/gradient.smk"
include: "smk/figures/robustness.smk"
include: "smk/figures/laplacian.smk"
include: "smk/figures/additivity.smk"
include: "smk/figures/highlight.smk"
include: "smk/figures/dimensions.smk"
include: "smk/figures/diffops.smk"
include: "smk/figures/sir.smk"

rule data:
    input:
        expand("data/processed/{ds}.pkl", ds=DATASETS)

rule train_ge:
    """
    Generate models (warning: computation intensive!)
    """
    input:
        expand("experiments/{dataset}/globalep/cv{cv}/model.pkl", cv=range(10), dataset=DATASETS),

rule train_ff:
    """
    Generate models (warning: computation intensive!)
    """
    input:
        expand("experiments/{dataset}/{model}/cv{cv}/model.pt", cv=range(10), model=["feedforward-K1-D1-W32", "feedforward-K8-D1-W32",], dataset=DATASETS),

rule train_torch:
    """
    Generate torch-based models (warning: computation intensive!)
    """
    input:
        expand(
            "experiments/{dataset}/{model}/cv{cv}/model.pt",
            cv=range(10),
            model=TORCH_MODELS,
            dataset=DATASETS,
        ),
        expand(
            "experiments/{dataset}/lantern/full/model.pt",
            dataset=["gfp-brightness", "laci-joint", "covid-joint"],
        ),
        expand(
            "experiments/{dataset}/{model}/cv{cv}-n{n}000/model.pt",
            dataset=["laci-joint", "gfp-brightness"],
            cv=range(10),
            model=["lantern", "feedforward-K8-D1-W32"],
            n=[5, 10, 15, 20, 25, 30, 35, 40]
        ),

rule train:
    """
    Generate models (warning: computation intensive!)
    """
    input:
        expand(
            "experiments/{dataset}/{model}/cv{cv}/model.pt",
            cv=range(10),
            model=TORCH_MODELS,
            dataset=DATASETS,
        ),
        expand(
            "experiments/{dataset}/globalep/cv{cv}/model.pkl",
            cv=range(10),
            dataset=DATASETS,
        ),

rule predict_torch:
    """
    Generate model predictions
    """
    input:
        expand(
            "experiments/{dataset}/{model}/cv{cv}/pred-val.csv",
            cv=range(10),
            model=TORCH_MODELS,
            dataset=DATASETS,
        ),
        expand(
            "experiments/{dataset}/{model}/cv{cv}-n{n}000/pred-val.csv",
            dataset=["laci-joint", "gfp-brightness"],
            cv=range(10),
            model=["lantern", "feedforward-K8-D1-W32"],
            n=[5, 10, 15, 20, 25, 30, 35, 40]
        ),

rule predict_ge:
    """
    Generate model predictions
    """
    input:
        expand(
            "experiments/{dataset}/globalep/cv{cv}/pred-val.csv",
            cv=range(10),
            dataset=DATASETS,
        )

rule predict:
    """
    Generate model predictions
    """
    input:
        rules.predict_torch.input,
        rules.predict_ge.input,

rule exp_figures:
    """
    Generate experiment figures for the manuscript.
    """
    input:
        # "figures/cvr2.png",
        # "figures/laci-joint/sample-size-ec50-norm.png",
        # "figures/laci-joint/sample-size-ginf-norm.png",
        # "figures/gfp-brightness/sample-size-phenotype.png",
        # "figures/covid-joint/sample-size-func_score_norm_exp.png",
        # "figures/covid-joint/sample-size-func_score_norm_bind.png",
        expand(
            "figures/{dstarg}/{fig}.png",
            dstarg=[
                "laci-joint/ec50",
                "laci-joint/ginf",
                "covid-joint/exp",
                "covid-joint/bind",
                "gfp-brightness/brightness",
            ],
            fig=["surface", "gradient", "robustness", "laplacian", "additivity", "sir-effects", "sir-dims"],
        ),
        expand(
            "figures/{dataset}/anglehist.png",
            dataset=["laci-joint", "covid-joint", "gfp-brightness"],
        ),
        # highlights
        "figures/gfp-brightness/brightness/surface-focus.png",
        "figures/gfp-brightness/brightness/surface-bfp1.png",
        "figures/gfp-brightness/brightness/surface-bfp2.png",
        "figures/laci-joint/parametric.png",
        "figures/covid-joint/anglehist-highlight.png",
        "figures/covid-joint/axes-surface.png",
        "figures/covid-joint/parametric.png",
        "figures/covid-joint/variants.png",
        "figures/covid-joint/variants_project.png",
    shell:
        "tar -czf figures.tar.gz figures/*"

rule pred_figures:
    """
    Generate prediction figures for the manuscript.
    """
    input:
        "figures/cvr2.png",
        "figures/laci-joint/sample-size-ec50-norm.png",
        "figures/laci-joint/sample-size-ginf-norm.png",
        "figures/gfp-brightness/sample-size-phenotype.png",
        "figures/covid-joint/sample-size-func_score_norm_exp.png",
        "figures/covid-joint/sample-size-func_score_norm_bind.png",
    shell:
        "tar -czf figures.tar.gz figures/*"

rule figures:
    """
    Generate all figures for the manuscript.
    """
    input:
        rules.exp_figures.input,
        rules.pred_figures.input,
    shell:
        "tar -czf figures.tar.gz figures/*"

rule help:
    """
    Print list of all targets with help.
    """
    run:
        for rule in workflow.rules:
            print(rule.name)
            print(rule.docstring)

rule environment:
    shell:
        """conda env export -n lantern > environment.yml"""

# rule a:
#     input: expand("tmp/in/{a}.txt", a=range(10))
#     output: "tmp/out/a.txt"
# 
# rule b:
#     input: "tmp/{a}/out.txt"
